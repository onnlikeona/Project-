---
title: "Application of Methods"
author: "Onalerona Letebele"
date: "24/09/2020"
output:
  html_document: default
  pdf_document: default
toc: yes
---
```{r echo=FALSE, eval=TRUE, message=FALSE}

library('depmixS4')
library('quantmod')
library('knitr')
set.seed(1)
```

# Introduction
----------------------------------

This short report will detail how the Hidden Markov Model is used to detect regime shifts in the financial market. This report will not cover the mathematical formulation behind the Hidden Markov Model but rather the focus will be attempting to show how the model performs when applied to simulated and real financial data. R will be used to achieve this and snippets of the code will be provided in-text to elucidate how the method works. Our learnings from this report will then be formally contextualized for our final paper. 

We will begin by giving a brief description of the Hidden Markov Model (HMM) and how it relates to the detection of financial market regime shifts in asset returns. This will then be followed by the application of the model on simulated data and the S&P500 returns data. Lastly, we will conclude on each model's perfomance in regime detection by comparing its results for the two forms of data as well as the alternative method.


# Hidden Markov Model
----------------------------------

Asset returns in financial markets are often subject to abrupt changes that do not display an observable process. The asset returns then remain in this transitioned state
for a considerable period of time before it's subject to another abrupt change. These persistent periods of time are referred to as market regimes. And the visible abrupt changes are in fact a result of a hidden or latent process. This hidden process is generated by another set of observations that are incomplete but that can be known. For example, changes in national or global policy. However, it is difficult to track these changes consistently and therefore a tool is needed to detect these shifts. This is where the Hidden Markov Model finds use. 

The Hidden Markov Model is based on the concept of a Markov Model. A Markov Model models the probability of moving from one state to another given the current state and disregarding the previous states. This is knwon as the Markov property and is said to be 'memoryless'. The Hidden Markov Model will link the observations to the underlying states under the Markov property. In our context, the observations are the asset returns which are visible and the states are the market regimes which are hidden. The figure below illustrates this with the orange bubbles being the states (market regimes) and the blue bubbles being the observations (asset returns):

```{r echo=FALSE}
include_graphics("C:/Users/student/Downloads/qs-hmm-state-model.png")

```


The observations (blue bubbles) are as a result of the hidden process that's occuring between the states (orange bubbles) as shown by the arrows. What we want the model to achieve is to indicate to us when the transition from one orange bubble to another actually happened. This will help in giving us insight on why an observation abruptly changed. The model can also help in indicating impending shifts, but this is beyond the scope of our project. 

The Hidden Markov Model will give the probaibility of being in a particular market regime given the sequence of asset returns (i.e. the posterior probability). Let's say for instance there exists two market regime states. The model will simply give us the posterior probability of either being in regime 1 or regime 2. Now if the model displays a posterior probability equal to 1 of being in regime 1 and a posterior probability of 0 of being in regime 2 and this now switches to a posterior probability of 0 and 1 respectively, then the time point at which that switch happened is where a regime shift had occured. 

## Simulated Data 
----------------------------------

We will now apply the Hidden Markov Model to a simulated dataset containing five separate market regimes each of which will be either a bullish or bearish market regime. The simulated asset returns will be generated from a normal distribution with parameters that correspond to the underlying market regime, each of which will either be a bullish or bearish market regime. In a bullish market, it is expected that the value of asset returns will rise. As such, we will assume that asset returns that fall under this regime will be normally distributed with a positive mean and low variance. Conversely, in a bearish market, asset returns are expected to decrease and we will assume that asset returns under this regime will be normally distributed with a negative mean and high variance. The five market regimes will form a single time path. The use of the model will then be to detect where the market regime shifts from bullish to bearish and vice versa.

Two market regimes will initally be simultaed. Each kth regime will have N_k days of the corresponding asset returns. In our example, we will let k = 5 and N_k be between 50 and 150 days. Asset returns under the bull market will be distributed as N(0.1, 0.1) while those of the bear market will be distributed as N(-0.05, 0.2). The parameters are assigned as follows in the code:

```{r}

# Parameters for the bull and bear market returns
Nk_lower <- 50
Nk_upper <- 150
bull_mean <- 0.1
bull_var <- 0.1
bear_mean <- -0.05
bear_var <- 0.2

```

The N_k values are then randomly chosen:

```{r message=FALSE}
# Number of days for each market regime
days <- replicate(5, sample(Nk_lower:Nk_upper, 1))
```
The asset returns corresponding to each of the kth regimes are randomly generated:

```{r message=FALSE}
# Bull and bear markets returns
market_bull_1 <- rnorm( days[1], bull_mean, bull_var ) 
market_bear_2 <- rnorm( days[2], bear_mean, bear_var ) 
market_bull_3 <- rnorm( days[3], bull_mean, bull_var ) 
market_bear_4 <- rnorm( days[4], bear_mean, bear_var ) 
market_bull_5 <- rnorm( days[5], bull_mean, bull_var )
```
We will now create true regime states and the final list  of asset returns, assigning a value of 1 for bullish market regimes and 2 for bearish ones:

```{r message=FALSE}
# List of true regime states and full returns list
true_regimes <- c( rep(1,days[1]), rep(2,days[2]), rep(1,days[3]), rep(2,days[4]), rep(1,days[5]))
returns <- c( market_bull_1, market_bear_2, market_bull_3, market_bear_4, market_bull_5)
```
If we plot the returns, we can clearly see the changes in mean and variance between the regime shifts:

```{r message=FALSE}
plot(returns, type="l", xlab='', ylab="Returns") 
```
At this stage, we can now fit the model with two market regimes:

```{r message=FALSE}
# Fit the Hidden Markov Model
hmm <- depmix(returns ~ 1, family = gaussian(), nstates = 2, data=data.frame(returns=returns))
hmmfit <- fit(hmm, verbose = FALSE)
```
Upon fitting the model, it is now possible to plot the probabilities of being in a particular regime stae given the asset returns (i.e. the posterior probabilities):

```{r message=FALSE}
# The true regimes and the posterior probabilities of the regimes
post_probs <- posterior(hmmfit)
layout(1:2)
plot(post_probs$state, type='s', main='True Regimes', xlab='', ylab='Regime')
matplot(post_probs[,-1], type='l', main='Regime Posterior Probabilities', ylab='Probability')
legend(x='topright', c('Bull','Bear'), fill=1:2, bty='n')
```
The True Regimes plot above shows the simulated regimes with a Regime Value of 1 and 2 indicating bullish and bearish markets respectively. The x axis indicates the index of the asset returns, which will the number of days. The Regime Posterior Probabilities plot gives the posterior probability of being in one of the two market regimes at any given time point. We can see that the model has correctly identified the number of regime shifts. However, the model lagged in quickly identifying the second regime shift around the 150th day, as well as the fourth shift at around the 270th day. Overall, the model performed well. One the reasons for this however, is that we knew the number of regime states. This will not be true for real time series data, which is what we will look at next.



Real Financial Time Series
----------------------------------

The goal of the Hidden Markov Model will be to identify the locations of switches between regime states. Since we have no idea how many regime states exist our goal is to locate the switches. The HMM function requires us to indicate the number of regime state, therefore we will have to make an initial estimate. For our initial estimate of the number of regime states, we need to consider the asset class and the trading manner for the asset and the time period chosen. 

We will be using the S&P 500 returns from 2004 onward. This data set is from the quantmod library. S&P 500 is a stock market index that measures the stock performance of 500 large companies listed on stock exchanges in the United States. It is one of the most commonly followed equity indices. To prepare the data, we have log the returns then take the first difference of the return. This transformation make the values easier to work with and interpret without losing much information.


```{r Real Data, echo=TRUE,eval=TRUE,message=FALSE}
getSymbols( "^GSPC", from="2004-01-01" )
real_returns = diff( log( Cl( GSPC ) ) )
real_returns2 = as.numeric(real_returns)
plot(real_returns,ylab="Returns",main = "S&P 500 Returns")
```

From the plot above we can see that the time series experiences some abrupt and large deviations at different times. The time series seems to be centered around zero. The variance seems to fluctuation around 2008, 2010, 2011 and 2020.  Between 2007-2009 the markets were incredibly volatile due to the sub-prime crisis.  

Now we want to identify all the switches between regime states.

At this stage we will make an initial estimate, there exists two regime states, "bullish" and "bearish" states. These two states represent the performance/behavior of the returns. An HMM can be fitted using the Expectation Maximization algorithm, the number of states is set to two and family of distributions set as Gaussian. We consider the posterior probabilities of being in a particular regime state. We compare compared the posterior probabilities with the returns.

```{r Fit2,eval=TRUE,echo=TRUE,message=FALSE}
hmm <- depmix(real_returns2 ~ 1, family = gaussian(), nstates = 2, data=data.frame(returns=real_returns2))
hmm_fit <- fit(hmm, verbose = FALSE)
post_probs <- posterior(hmm_fit)
layout(1:2)
plot(real_returns,ylab="Returns",main = "S&P 500 Returns")
matplot(post_probs[,-1], type='l', main='Regime Posterior Probabilities', ylab='Probability')
legend(x='bottomleft', c('Bull Regime','Bear Regime'), fill=1:2, bty='n')
```


From the above plot we can see how the HMM identified the probability of the time series of being in one of the two regime states. Before 2007, the returns were calmer and hence the Hidden Markov Model has given high posterior probability to a Bull state. Then between 2007-2009 the returns were incredibly volatile due to the sub-prime crisis. The returns became calmer in 2010 but additional volatility occurred in 2011. The length of the data make the graph harder to read but we can see that after 2007 the HMM indicates many switches between the two states. This is consistent with the S&P500 returns plotted above. Between 2007-2009 the markets were incredibly volatile due to the sub-prime crisis. We can also see abrupt volatility in March 2020, due to the Covid-19 pandemic.

Our initial estimate of the number of regime states was two, but what if we were wrong and there exists multiple regime states. Lets see what happens if we indicate three regime states in the HMM function.

```{r Fit3,eval=TRUE,echo=TRUE,message=FALSE}
hmm <- depmix(real_returns2 ~ 1, family = gaussian(), nstates = 3, data=data.frame(returns=real_returns2))
hmm_fit <- fit(hmm, verbose = FALSE)
post_probs <- posterior(hmm_fit)
layout(1:2)
plot(real_returns)
matplot(post_probs[,-1], type='l', main='Regime Posterior Probabilities', ylab='Probability')
legend(x='bottomleft', c('Regime #1','Regime #2', 'Regime #3'), fill=1:3, bty='n')
```

The plot above is hard to read but we observe multiple switches between regime states. To an untrained eye the two state fitted model might seem like a better fit, although there might exist a third (hidden) state and financial experts would find this plot very useful. Choosing the initial number of regime states to apply is a challenging task, so we need to do some data exploration before fitting the model to produce better results.

# STARS Method
----------------------------------

We will now look at the STARS method to detect market regime shifts. For this report we are going to consider a shift in the mean as outlined by Rodionov. A very brief summary of how the method works follows. We firstly calculate the mean for for a particular cutoff period. The cutoff is the period of time that we believe should constitute a regime, according to the context. We then recalculate the mean but with the next observation in our time series included. If the inclusion of this observation changes the previous mean siginificantly, that time point (eg. t2) is flagged as a potential regime shift. To confirm that this time point is indeed indicative of a regime shift, we calculate the RSI for each observation following our potential time point (t2). If the RSI changes signs for any subsequent observations (eg. if the RSI for t2 is 0.5 and for t3 -0.5) within a certain cutoff, then the potential time point (t2) is not considered to be indicative of a regime shift.

The cutoff is the only parameter that we need to define for our example. The default pvalue for the t-test is 0.05. To  make the plots easier to analyse, the RSI plot only displays the RSI values of potential time points. It will not diplay the RSI values that are calculated after a potential time point. RSI values of potential time points that later turned out to be not be regime shift timepoint (due to the RSI changing signs down the line, within the cutoff period) will also not be displayed. As such, the number of RSI bars that we see on the plot will be equal to the number of regime shifts the model has predicted.

## Simulated Time Series 
----------------------------

We will use the same previously simulated data containing four shifts in the mean between two mean states.

```{r Sim2,eval=TRUE,echo=FALSE}
plot(sim_returns, type="l", xlab="days", ylab="Returns",main = "Simulated Markert Returns Over a Number of Days ")
```


The plot above is our simulated time series with five regime shifts between the two regime states, "Bull" and "Bear" states,  Now lets fit the STARS method and see if it can detect all five regime shifts. The "rstars()" function requires us to indicate the cut-off length of the regimes to be tested. This means we need to tell the function how many subsequent observations should be used to test whether the potential change point represents a shift in the mean. This value is subjective to the data being used and other surrounding factors. For our simulated data we will use a cut-off length of 10 days.


```{r Fit4,echo=TRUE,eval=TRUE,message=FALSE}
source("rSTARS.R")
Time <- as.character(seq(as.Date("2004-01-01"),as.Date("2004-12-11"),by = "day"))
sim_returns_data <- data.frame(cbind(Time, sim_returns))
sim_returns_data$sim_returns <- as.numeric(sim_returns_data$sim_returns)
layout(1:3)
plot(sim_returns,type="l",main = "Simulated Returns")
rstars (sim_returns_data, l.cutoff = 10,save.path = getwd())
```


From the plot above we can see that the STARS method identifies when there is a switch between regime states. The STARS method indicates that there are four regime shifts which is consistent with our simulated data.

RSI represents a cumulative sum of normalized deviations from the mean level for the new regime. If RSI remains positive throughout (l - 1), then the potential change point is declared to be the time of a regime shift. 

The RSI index graph shows four index values being positive indicating four regime shifts. The Regime shift detection graph also indicates four regime shifts and we can see a pattern of mean levels. The returns are either centered around 0.1 or -0.05. Which are the same mean levels we simulated. Therefore, the Regime shift detection graph tells us that there are four shifts in the mean between two mean levels. This method provides more informative results than the HMM. These results are easier to interpret because we know how the data behaves. Let's see how this method preforms against real financial data sets. 

## Real Financial Time Series
----------------------------------

We will use the same S&P 500 return time series used above to compare the performances of both detection methods. We will use a cut-off length of 31 days.


```{r Fit5,echo=TRUE,eval=FALSE,message=FALSE}
real_returns_data <- data.frame(date=index(real_returns),coredata(real_returns))
real_returns_data <- na.omit(real_returns_data)
colnames(real_returns_data) <- c("Date","S&P500 Returns")
layout(1:3)
plot(real_returns_data$`S&P500 Returns`,type="l",main = "S&P500 Returns")
rstars(real_returns_data, l.cutoff = 31,save.path = getwd())
```


From the plot above we can see that the STARS method detects ten shifts in the mean between seven mean levels/states. The RSI index graph indicates ten rsi index values being positive indicating ten regime shifts. These results are very different from the ones obtained using the HMM method. Using HMM method we had to indicate the number of regime states beforehand, whereas STARS tells us how many regime states exist. An important aspect of the STARS method is the cut-off length of the regime. If we change the length from 31 days to 60 days we obtains very different results. When the cut-off length is 60 days, the STARS indicates three shifts in the mean between two mean levels/states. 

For larger cut-off lengths, the algorithm has more observations to use to decide whether the potential change point is statistically significant. Therefore, what could be having here is when the length is 60 days, the deviations have enough time to normalize and collectively do not significantly deviate from the initail mean level/state. 

STARS method provides more informative results then the HMM since we do not always know how many regime states exist in out time series.

In terms of performance both methods performed very well with the simulated random time series. Both methods detected all shifts in the mean and STARS detected the number of mean levels/states. We could also investigate how the methods perform with more complex simulated time series. Where, the observations are correlated and have multiple regime states. 

References
---------------------------

Stirnimann, L., Conversi, A., and Marini, S. 2019. Detection of regime shifts in the environment: testing “STARS” using synthetic and observed time series. ICES Journal of Marine Science.

Rodionov, S. and Overland, J.E., 2005. Application of a sequential regime shift detection method to the Bering Sea ecosystem. ICES Journal of Marine Science, 62(3), pp.328-332.

Rodionov, S.N., 2004. A sequential algorithm for testing climate regime shifts. Geophysical Research Letters, 31(9).
