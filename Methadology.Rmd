---
title: "Project Deliverable Methadology"
output: html_document
---

# Introduction

This short report will detail how the Hidden Markov Model is used to detect regime shifts in the financial market. This report will not cover the mathematical formulation behind the Hidden Markov Model but rather the focus will be attempting to show how the model performs when applied to simulated and real financial data. R will be used to achieve this and snippets of the code will be provided in-text to elucidate the how the method works. Our learnings from this report will then be formally contextualized in our final paper. 

We will begin by giving a brief description of the Hidden Markov Model (HMM) and how it relates to the detection of financial market regime shifts in asset returns. This will then be followed by the application of the model on simulated nd the S&P500 returns data. Lastly, we will conclude on the model's perfomance in regime detection by comparing its results to the two forms of data as well as the alternative method, that being STARS.


# Hidden Markov Models and Market Regimes

Asset returns in financial markets are often subject to abrupt changes that do not display an observable process. The asset returns then remain in this transitioned state
for a considerable period of time before it's subject to another abrupt change. These persistent periods of time are referred to as market regimes. And the visible abrupt changes are in fact a result of a hidden or latent process. This hidden process is generated by another set of observations that are incomplete but that can be known. For example, changes in national or global policy. However, it is difficult to track these changes consistently and therefore a tool is needed to detect these shifts. This is where the Hidden Markov Model finds use. 

The Hidden Markov Model is based on the concept of a Markov Model. A Markov Model models the probability of moving from one state to another given the current state and disregarding the previous states. This is knwon as the Markov property and is said to be 'memoryless'. The Hidden Markov Model will link the observations to the underlying states under the Markov property. In our context, the observations are the asset returns which are visible and the states are the market regimes which are hidden. The figure below illustrates this with the orange bubbles being the states (market regimes) and the blue bubbles being the observations (asset returns):

[insert image]

The observations (blue bubbles) are as a result of the hidden process that's occuring between the states (orange bubbles) as shown by the arrows. What we want the model to achieve is to indicate to us when the transition from one orange bubble to another actually happened. This will help in giving us insight on why an observation abruptly changed. The model can also help in indicating impending shifts, but this is beyond the scope of our project. 

More formally put, the model will gives the probaibility of being in a particular market regime given the sequence of asset returns (i.e. the posterior probability). Let's say for instance there exists two market regime states. The model will simply give us the posterior probability of either being in regime 1 or regime 2. Now if the model displays a posterior probability equal to 1 of being in regime 1 and a posterior probability of 0 of being in regime 2 and this now switches to a posterior probability of 0 and 1 respectively, then the time point at which that switch happened is where a regime shift occured. 

# Simulated Data 

We will now apply the Hidden Markov Model to a simulated dataset containing five separate market regimes. We will then infer the probability of being in a particular market regime state given the sequence of asset returns.  instance the probability of being in market regime 1 is low and the probability of being in market regime 2 is high - given the asset returns, 

The simulated asset returns will be generated from a normal distribution with parameters that correspond to the underlying market regime, each of which will either be a bullish or bearish market regime. In a bullish market, it is expected that the value of asset returns will rise. As such, we will assume that asset returns that fall under this regime will be normally distributed with a positive mean and low variance. Conversely, in a bearish market, asset returns are expected to decrease and we will assume that asset returns under this regime will be normally distributed with a negative mean and high variance. The five market regimes will form a single time path. The use of the model will then be to detect where the market regime shifts from bullish to bearish and vice versa.

## Model Fitting

Two market regimes will initally be simultaed. Each kth regime will have N_k days of the corresponding asset returns. In our example, we will let k = 5 and N_k be between 50 and 150 days. Asset returns under the bull market will be distributed as N(0.1, 0.1) while those of the bear market will be distributed as N(-0.05, 0.2). The parameters are assigned as follows in the code:

```{r}

# Parameters for the bull and bear market returns
Nk_lower <- 50
Nk_upper <- 150
bull_mean <- 0.1
bull_var <- 0.1
bear_mean <- -0.05
bear_var <- 0.2

```

The N_k values are then randomly chosen:

```{r}
# Number of days for each market regime
days <- replicate(5, sample(Nk_lower:Nk_upper, 1))
```
The asset returns corresponding to each of the kth regimes are randomly generated:

```{r}
# Bull and bear markets returns
market_bull_1 <- rnorm( days[1], bull_mean, bull_var ) 
market_bear_2 <- rnorm( days[2], bear_mean, bear_var ) 
market_bull_3 <- rnorm( days[3], bull_mean, bull_var ) 
market_bear_4 <- rnorm( days[4], bear_mean, bear_var ) 
market_bull_5 <- rnorm( days[5], bull_mean, bull_var )
```
We will now create true regime states and the final list  of asset returns, assigning a value of 1 for bullish market regimes and 2 for bearish ones:

```{r}
# List of true regime states and full returns list
true_regimes <- c( rep(1,days[1]), rep(2,days[2]), rep(1,days[3]), rep(2,days[4]), rep(1,days[5]))
returns <- c( market_bull_1, market_bear_2, market_bull_3, market_bear_4, market_bull_5)
```
If we plot the returns, we can clearly see the changes in mean and variance between the regime shifts:

```{r}
plot(returns, type="l", xlab='', ylab="Returns") 
```
At this stage, we can now fit the model with two market regimes:

```{r}
# Fit the Hidden Markov Model
hmm <- depmix(returns ~ 1, family = gaussian(), nstates = 2, data=data.frame(returns=returns))
hmmfit <- fit(hmm, verbose = FALSE)
```
Upon fitting the model, it is now possible to plot the probabilities of being in a particular regime stae given the asset returns (i.e. the posterior probabilities):

```{r}
# The true regimes and the posterior probabilities of the regimes
post_probs <- posterior(hmmfit)
layout(1:2)
plot(post_probs$state, type='s', main='True Regimes', xlab='', ylab='Regime')
matplot(post_probs[,-1], type='l', main='Regime Posterior Probabilities', ylab='Probability')
legend(x='topright', c('Bull','Bear'), fill=1:2, bty='n')
```
The figure above shows that the model peforms well in correctly identifying the market regimes although not perfectly.



# The first task is to install the depmixS4 and quantmod libraries and then import them into R. We set a seed to allow for reproduciblity of results:

```{r setup, include=FALSE}
library('depmixS4')
library('quantmod')
```

## Using real financial data

# The goal of the Hidden Markov Model will be to identify when the regime has switched from bullish to bearish and vice # versa. But unlike the simulated data set we don't know the number of regimes states that exsist and the distribution family our data belongs to. This is a unsupervised learning challenge since the number of states is not known and the # data is not labeled. Our initial estimate of the number of regime states, we need to consider the assest class, trading manner for the assest and the time period chosen. 

# We will be using the S&P500 returns from 2004 onwards. This data set is from the quantmod library. 


```{r Data, echo=TRUE,eval=TRUE,message=FALSE}
getSymbols( "^GSPC", from="2004-01-01" )
Rets = diff( log( Cl( GSPC ) ) )
returns = as.numeric(Rets)
```

## Plotting our Time Series

```{r Plot, echo=TRUE,eval=TRUE}
plot(Rets)
```

# From the plot above we can see that the time series experiences some sharp and large deviations at different times. The time series seems to be centered around zero. The variance seems to fluctuation around 2008, 2010, 2011 and 2020. 

# Now we want to identify all the switches between regime states.

## Fitting  Hidden Markov Model

# At this stage we will make an initial estimate, there exists two regime states, "bullish" and "bearish" states. These two states represent the performance/behaviour of the returns. An HMM can be fitted using the Expectation Maximisation algorithm, the number of states is set to two and family of distributions set as gaussian. We consider the posterior probabilities of being in a particular regime state. We compare compared the posterior probabilities with the returns.

```{r Fitting,eval=TRUE,echo=TRUE}
hmm <- depmix(returns ~ 1, family = gaussian(), nstates = 2, data=data.frame(returns=returns))
hmm_fit <- fit(hmm, verbose = FALSE)
post_probs <- posterior(hmm_fit)
layout(1:2)
plot(Rets)
matplot(post_probs[,-1], type='l', main='Regime Posterior Probabilities', ylab='Probability')
legend(x='bottomleft', c('Regime #1','Regime #2'), fill=1:2, bty='n')
```
# Hidden markov model split the time series into two regime and identified where each regime exists. Before 2007 the returns were calmer and hence the Hidden Markov Model has given high posterior probability to Regime #1 for this period. However between 2007-2009 the returns were incredibly volatile due to the sub-prime crisis. The returns became calmer in 2010 but additional volatility occurred in 2011.

## Fitting  Hidden Markov Model with 3 Regime states

# Lets consider fitting the Hidden Markov Model but now setting the number of regime states to three and analyse the results.

```{r Fitting3 ,eval=TRUE,echo=TRUE}
hmm <- depmix(returns ~ 1, family = gaussian(), nstates = 3, data=data.frame(returns=returns))
hmm_fit <- fit(hmm, verbose = FALSE)
post_probs <- posterior(hmm_fit)
layout(1:2)
plot(Rets)
matplot(post_probs[,-1], type='l', main='Regime Posterior Probabilities', ylab='Probability')
legend(x='bottomleft', c('Regime #1','Regime #2', 'Regime #3'), fill=1:3, bty='n')
```

# The plot is tricky to read but we can see that the regime exsist very close to each other. Since the model considers three regimes states, this leads to a switching behaviour between regimes. Choosing the initial number of states to apply is a challenging task, so we need to do data exporation before fiiting the model to produce better results.

## STARS Method

# Above we made use of Hidden Markov Models to detect changes in regime states. Now lets use another meothd called STARS # to detect these changes.

# We start off by simulating our data. 
```{r Simulated,eval=TRUE,echo=FALSE}
days <- replicate(5, sample(50:100,1))
market_bull_1 <- rnorm( days[1], 0.1,0.1) 
market_bear_2 <- rnorm( days[2], -0.05,0.2) 
market_bull_3 <- rnorm( days[3],0.1,0.1) 
market_bear_4 <- rnorm( days[4],-0.05,0.2) 
market_bull_5 <- rnorm( days[5],0.1,0.1)
# Create the list of true regime states and full returns list
true_regimes <- c( rep(1,days[1]), rep(2,days[2]), rep(1,days[3]), rep(2,days[4]), rep(1,days[5]))
returns <- c( market_bull_1, market_bear_2, market_bull_3, market_bear_4, market_bull_5)
returns <- as.vector(returns)
names(returns) <- as.character(1900:(1900+(length(returns)-1)))
plot(returns, type="l", ylab="Returns")
```

# We simulate market returns that switch between a "bullish" regime state to a "bearish" regime state. Therefore there are only two regime states in our data. Our returns in the "bullish" regime state are from a normal distribution with a mean of 0.1 and a varuance of 0.1. Our returns in the "bearish" regime state are from a normal distribution with a mean of -0.05 and a varuance of 0.2. We would like the STARS function to detect when the returns switch between regime states.

```{r Fitting,echo=TRUE,eval=TRUE}
years <- seq(1900:(1900+(length(returns)-1)))
shift <- stars(returns)
plot.stars(shift,years)
```
# From the plot above we can see that the STARS method identifies when there is a switch between regime states.
# The STARS method indicates that there are four regime shifts which is consistent with our simulated data.
# When using real financial data this type of result will only tell us about how many shifts there are between regime 
# states and not how many regime states exsist in the data.

## Real Data

We will make use of the same S&P500 data as used for the Hidden Markov Model:

``` {r}
getSymbols( "^GSPC", from="2004-01-01" )
Rets = diff( log( Cl( GSPC ) ) )
returns = as.numeric(Rets)
names(returns) <- seq(1900:(1900+(length(returns)-1)))
years <- seq(1900:(1900+(length(returns)-1)))
shift <- stars(returns)
pl
plot.stars(shift,years)
